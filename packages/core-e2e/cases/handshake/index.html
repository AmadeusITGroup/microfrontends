<meta
	http-equiv="Content-Security-Policy"
	content="
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  frame-src 'self' http://localhost:8092;
"
/>

<base href="/handshake/" />

<h1>Host</h1>

<h3>Messages</h3>
<div id="messages"></div>

<br />

<iframe id="iframe-same-origin-no-sandbox" src="iframe-same-origin-no-sandbox.html"></iframe>
<iframe
	id="iframe-same-origin-allow-scripts"
	sandbox="allow-scripts"
	src="iframe-same-origin-allow-scripts.html"
></iframe>
<iframe
	id="iframe-not-same-origin-no-sandbox"
	src="http://localhost:8092/handshake/iframe-not-same-origin-no-sandbox.html"
></iframe>
<iframe
	id="iframe-not-same-origin-allow-scripts"
	sandbox="allow-scripts"
	src="http://localhost:8092/handshake/iframe-not-same-origin-allow-scripts.html"
></iframe>
<iframe
	id="iframe-not-same-origin-allow-scripts-origin"
	sandbox="allow-scripts allow-same-origin"
	src="http://localhost:8092/handshake/iframe-not-same-origin-allow-scripts-origin.html"
></iframe>

<script type="module">
	import { MessagePeer } from '/core.js';

	const knownMessages = [{ type: 'test', version: '1.0' }];

	// 0. no iframe
	const host = new MessagePeer({
		id: 'host',
		knownMessages,
	});
	host.messages.subscribe((m) => {
		const messages = document.getElementById('messages');
		messages.innerHTML += `<div id="${m.from}">${m.from}</div>`;
	});

	host.listen([
		'client-0',
		'client-1',
		{
			id: 'client-2',
			source: document.getElementById('iframe-same-origin-allow-scripts').contentWindow,
		},
		{
			id: 'client-4',
			source: document.getElementById('iframe-not-same-origin-allow-scripts').contentWindow,
			origin: 'http://localhost:8092',
		},
		{
			id: 'client-3',
			source: document.getElementById('iframe-not-same-origin-no-sandbox').contentWindow,
			origin: 'http://localhost:8092',
		},
		{
			id: 'client-5',
			source: document.getElementById('iframe-not-same-origin-allow-scripts-origin').contentWindow,
			origin: 'http://localhost:8092',
		},
	]);

	host.send(
		{
			type: 'test',
			version: '1.0',
			data: 'no iframe',
		},
		{ to: ['client-0'] },
	);

	const client = new MessagePeer({
		id: 'client-0',
		knownMessages,
	});
	client.connect('host');
	client.send(
		{
			type: 'test',
			version: '1.0',
			data: 'no iframe',
		},
		{ to: ['host'] },
	);
</script>
